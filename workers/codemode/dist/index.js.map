{
  "version": 3,
  "sources": ["../src/index.ts"],
  "sourceRoot": "dist",
  "sourcesContent": ["import { WorkerEntrypoint } from \"cloudflare:workers\";\n\ntype Env = {\n  LOADER: any;\n  PROXY_URL: string;\n  PROXY_TOKEN: string;\n  CODEMODE_CLIENT_TOKEN?: string;\n};\n\ntype OutboundProps = { allowedHost: string; proxyToken?: string };\n\nfunction jsonResponse(body: any, status = 200) {\n  return new Response(JSON.stringify(body), {\n    status,\n    headers: { \"content-type\": \"application/json\" },\n  });\n}\n\n// Outbound guard to keep the dynamic worker confined to the proxy endpoint\nexport class OutboundProxy extends WorkerEntrypoint<OutboundProps> {\n  async fetch(request: Request): Promise<Response> {\n    const url = new URL(request.url);\n    if (url.host !== this.ctx.props.allowedHost) {\n      return new Response(\"Blocked outbound host\", { status: 403 });\n    }\n\n    const headers = new Headers(request.headers);\n    if (this.ctx.props.proxyToken) {\n      headers.set(\"x-codemode-token\", this.ctx.props.proxyToken);\n    }\n\n    const forwarded = new Request(request, { headers });\n    return fetch(forwarded);\n  }\n}\n\n// Helper to build a module that wraps user code\nfunction buildRunnerModule(userCode: string, helpersImplementation: string): string {\n  const userLines = userCode.split(/\\r?\\n/);\n  const executionLines: string[] = [\n    \"    const userFunction = async (helpers, console) => {\",\n    \"      return (async () => {\",\n    ...userLines.map((line) => `        ${line}`),\n    \"      })();\",\n    \"    };\",\n  ];\n  const executionCode = executionLines.join(\"\\n\");\n  \n  return `\n    ${helpersImplementation || ''}\n\n    export default {\n      async fetch(request, env) {\n        const logs = [];\n        const safeConsole = {\n          log: (...args) => {\n            try {\n              const safe = args.map((v) => {\n                if (typeof v === 'string') return v;\n                try { return JSON.stringify(v); } catch { return String(v); }\n              }).join(' ');\n              logs.push(safe);\n            } catch {\n              logs.push('[log error]');\n            }\n          },\n          error: (...args) => safeConsole.log(...args),\n          warn: (...args) => safeConsole.log(...args),\n          info: (...args) => safeConsole.log(...args),\n        };\n        const console = safeConsole;\n        // Define proxy functions inside fetch handler where env is available\n        async function callProxy(server, tool, args) {\n          const headers = new Headers({ 'content-type': 'application/json' });\n          if (env.PROXY_TOKEN) headers.set('x-codemode-token', env.PROXY_TOKEN);\n          let res;\n          try {\n            res = await fetch(env.PROXY_URL, {\n              method: 'POST',\n              headers,\n              body: JSON.stringify({ server, tool, args })\n            });\n          } catch (error) {\n            const reason = error instanceof Error ? error.message : String(error);\n            throw new Error(\n              \"Failed to reach Code Mode proxy (\" +\n                env.PROXY_URL +\n                \") while calling \" +\n                server +\n                \"/\" +\n                tool +\n                \": \" +\n                reason\n            );\n          }\n          const text = await res.text();\n          let parsed = null;\n          try { parsed = text ? JSON.parse(text) : null; } catch {}\n          if (!res.ok) {\n            throw new Error(parsed?.error || text || ('Proxy error ' + res.status));\n          }\n          return parsed?.result ?? null;\n        }\n\n        // Make __invokeMCPTool available globally for helpers\n        globalThis.__invokeMCPTool = async function(server, tool, args) {\n          return callProxy(server, tool, args);\n        };\n\n        const helpers = globalThis.helpers || {};\n\n        try {\n          ${executionCode}\n\n          const result = await userFunction(helpers, safeConsole);\n          const payload = {\n            logs,\n            result: result === undefined ? null : result,\n          };\n\n          return new Response(JSON.stringify(payload), {\n            status: 200,\n            headers: { 'content-type': 'application/json' }\n          });\n        } catch (err) {\n          safeConsole.log('[error]', err && err.message ? err.message : String(err));\n          return new Response(JSON.stringify({\n            error: err instanceof Error ? err.message : String(err),\n            logs\n          }), {\n            status: 500,\n            headers: { 'content-type': 'application/json' }\n          });\n        }\n      }\n    };\n  `;\n}\n\nexport default {\n  async fetch(request: Request, env: Env, ctx: ExecutionContext): Promise<Response> {\n    if (request.method === \"OPTIONS\") {\n      return new Response(null, { status: 204, headers: { \"Access-Control-Allow-Origin\": \"*\" } });\n    }\n\n    if (env.CODEMODE_CLIENT_TOKEN) {\n      const headerToken = request.headers.get(\"x-codemode-token\");\n      if (headerToken !== env.CODEMODE_CLIENT_TOKEN) {\n        return jsonResponse({ error: \"Unauthorized\" }, 401);\n      }\n    }\n\n    if (request.method !== \"POST\") {\n      return jsonResponse({ error: \"Use POST\" }, 405);\n    }\n\n    if (!env.PROXY_URL) {\n      return jsonResponse({ error: \"Missing PROXY_URL binding\" }, 500);\n    }\n\n    // Parse the request to get the user's code\n    let payload: any = {};\n    try {\n      payload = await request.json();\n    } catch {\n      return jsonResponse({ error: \"Invalid JSON\" }, 400);\n    }\n\n    const code = typeof payload?.code === 'string' ? payload.code : '';\n    if (!code) {\n      return jsonResponse({ error: \"Missing code\" }, 400);\n    }\n\n    const proxyHost = (() => {\n      try { return new URL(env.PROXY_URL).host; } catch { return \"\"; }\n    })();\n\n    // Build a dynamic module with the user's code embedded\n    let helpersImplementation = typeof payload?.helpersImplementation === 'string' ? payload.helpersImplementation : '';\n    if (!helpersImplementation) {\n      console.log(\"[CodeMode Worker] payload missing helpersImplementation, injecting stub\");\n      helpersImplementation = \"const helpers = {}; globalThis.helpers = helpers;\";\n    }\n    // Log first 500 chars to debug\n    console.log(\"[CodeMode Worker] helpersImplementation preview:\", helpersImplementation.substring(0, 500));\n    const helperMatches = Array.from(\n      new Set((helpersImplementation.match(/helpers\\\\.([a-z0-9_]+)/gi) || []).map((m) => m.replace(/^helpers\\\\./, \"\")))\n    );\n    console.log(\"[CodeMode Worker] helpersImplementation length=\", helpersImplementation.length);\n    console.log(\"[CodeMode Worker] helper keys:\", helperMatches.join(\", \"));\n    const runnerModule = buildRunnerModule(code, helpersImplementation);\n\n    const isolateId = `codemode-${crypto.randomUUID()}`;\n    const loaderConfig: any = {\n      compatibilityDate: \"2025-06-01\",\n      mainModule: \"runner.js\",\n      modules: {\n        \"runner.js\": runnerModule,\n      },\n      env: {\n        PROXY_URL: env.PROXY_URL,\n        PROXY_TOKEN: env.PROXY_TOKEN,\n      },\n    };\n    \n    // Only set globalOutbound in production where ctx.exports is available\n    if (ctx.exports && ctx.exports.OutboundProxy) {\n      loaderConfig.globalOutbound = ctx.exports.OutboundProxy({ props: { allowedHost: proxyHost, proxyToken: env.PROXY_TOKEN } });\n    }\n    \n    const loader = env.LOADER.get(isolateId, () => loaderConfig);\n\n    const entrypoint = loader.getEntrypoint();\n    return entrypoint.fetch(new Request(\"https://sandbox.internal/run\", {\n      method: \"POST\",\n      headers: { \"content-type\": \"application/json\" },\n      body: JSON.stringify({}),\n    }));\n  },\n};\n"],
  "mappings": "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",
  "names": []
}
